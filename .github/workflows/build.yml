name: Build Hardened Images

on:
  push:
    branches: [main]
    paths:
      - '*/apko/*.yaml'
      - '*/melange.yaml'
      - '*/test.sh'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main]
  schedule:
    # Rebuild daily at 2am UTC to get latest CVE patches
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  JENKINS_VERSION: "2.541.1"

jobs:
  #----------------------------------------------------------------------------
  # BUILD ALL IMAGES (matrix-driven)
  #----------------------------------------------------------------------------
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: python
            apko_config: python/apko/python.yaml
            build_type: apko
          - name: jenkins
            apko_config: jenkins/apko/jenkins.yaml
            melange_config: jenkins/melange.yaml
            build_type: melange
          - name: node-slim
            apko_config: node-slim/apko/node.yaml
            build_type: apko
          - name: go
            apko_config: go/apko/go.yaml
            build_type: apko
          - name: nginx
            apko_config: nginx/apko/nginx.yaml
            build_type: apko
          - name: httpd
            apko_config: httpd/apko/httpd.yaml
            build_type: apko
          - name: redis-slim
            apko_config: redis-slim/apko/redis.yaml
            melange_config: redis-slim/melange.yaml
            build_type: melange
          - name: postgres-slim
            apko_config: postgres-slim/apko/postgres.yaml
            build_type: apko
          - name: bun
            apko_config: bun/apko/bun.yaml
            build_type: apko
          - name: sqlite
            apko_config: sqlite/apko/sqlite.yaml
            build_type: apko
          - name: dotnet
            apko_config: dotnet/apko/dotnet.yaml
            build_type: apko

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apko
        run: |
          go install chainguard.dev/apko@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install melange
        if: matrix.build_type == 'melange'
        run: go install chainguard.dev/melange@latest

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate melange signing key
        if: matrix.build_type == 'melange'
        run: melange keygen

      - name: Build package with melange
        if: matrix.build_type == 'melange'
        run: |
          melange build ${{ matrix.melange_config }} \
            --arch x86_64,aarch64 \
            --signing-key melange.rsa \
            --out-dir ./packages \
            --runner docker

      - name: Build image with apko
        run: |
          EXTRA_ARGS=""
          if [ "${{ matrix.build_type }}" = "melange" ]; then
            EXTRA_ARGS="--repository-append ./packages --keyring-append ${{ github.workspace }}/melange.rsa.pub"
          fi
          apko build ${{ matrix.apko_config }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }} \
            ${{ matrix.name }}.tar \
            --arch x86_64 \
            $EXTRA_ARGS
          docker load < ${{ matrix.name }}.tar
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep "minimal-${{ matrix.name }}" | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## ${{ matrix.name }} Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep "minimal-${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY || true

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Scan image for vulnerabilities
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          trivy image \
            --format json \
            --output trivy-${{ matrix.name }}.json \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            "$IMAGE"

      - name: Generate vulnerability report
        if: always()
        run: |
          REPORT="trivy-${{ matrix.name }}.json"
          if [ ! -f "$REPORT" ]; then
            echo "## Security Scan: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
            echo "Scan report not found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Count vulnerabilities by severity across all results
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$REPORT")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$REPORT")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$REPORT")
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$REPORT")
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

          # Header
          echo "## Security Scan: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan date:** $(date -u +%Y-%m-%d) | **Image:** minimal-${{ matrix.name }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary table
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "| LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL" -eq 0 ]; then
            echo "No vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Detailed table for CRITICAL and HIGH
          if [ "$((CRITICAL + HIGH))" -gt 0 ]; then
            echo "### CRITICAL / HIGH Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Library | CVE | Severity | Installed | Fixed | Title |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----|----------|-----------|-------|-------|" >> $GITHUB_STEP_SUMMARY
            jq -r '
              [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")]
              | sort_by(.Severity) | reverse[]
              | "| \(.PkgName) | \(.VulnerabilityID) | \(.Severity) | \(.InstalledVersion) | \(.FixedVersion // "n/a") | \(.Title // "n/a" | .[0:80]) |"
            ' "$REPORT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "No CRITICAL or HIGH vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload vulnerability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ matrix.name }}
          path: trivy-${{ matrix.name }}.json
          retention-days: 90

      - name: Generate SARIF report
        if: always()
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          trivy image \
            --format sarif \
            --output trivy-${{ matrix.name }}.sarif \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            "$IMAGE" || true

      - name: Upload SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.name }}.sarif'

      - name: Test image
        run: |
          export IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          ./${{ matrix.name }}/test.sh

      - name: Publish image
        if: github.event_name != 'pull_request'
        run: |
          EXTRA_ARGS=""
          if [ "${{ matrix.build_type }}" = "melange" ]; then
            EXTRA_ARGS="--repository-append ./packages --keyring-append ${{ github.workspace }}/melange.rsa.pub"
          fi
          apko publish ${{ matrix.apko_config }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:latest \
            --arch x86_64,aarch64 \
            $EXTRA_ARGS

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:latest

  #----------------------------------------------------------------------------
  # SUMMARY
  #----------------------------------------------------------------------------
  summary:
    needs: [build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "::error::One or more images failed"
            exit 1
          fi
          echo "All hardened images built successfully!"

  #----------------------------------------------------------------------------
  # CLEANUP OLD VERSIONS
  #----------------------------------------------------------------------------
  cleanup:
    needs: [build]
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      packages: write
    steps:
      - name: Delete old untagged versions
        run: |
          gh api "/users/${{ github.repository_owner }}/packages?package_type=container" \
            --paginate --jq '.[].name' 2>/dev/null | \
          while read -r pkg; do
            echo "Cleaning old versions from $pkg..."
            gh api "/users/${{ github.repository_owner }}/packages/container/$pkg/versions" \
              --paginate --jq '[.[] | select(.metadata.container.tags | length == 0)] | sort_by(.created_at) | reverse | .[10:] | .[].id' 2>/dev/null | \
            while read -r id; do
              echo "  Deleting version $id"
              gh api --method DELETE "/users/${{ github.repository_owner }}/packages/container/$pkg/versions/$id" 2>/dev/null || true
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
