name: Build Hardened Images

on:
  push:
    branches: [main]
    paths:
      - '*/apko/*.yaml'
      - '*/melange.yaml'
      - '*/test.sh'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main]
  schedule:
    # Rebuild daily at 2am UTC to get latest CVE patches
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions: {}

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  #----------------------------------------------------------------------------
  # GENERATE EPHEMERAL SIGNING KEY (PRs only - secrets not available for forks)
  #----------------------------------------------------------------------------
  keygen:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {}
    steps:
      - name: Install melange
        run: |
          go install chainguard.dev/melange@v0.41.1
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Generate ephemeral signing key
        run: |
          echo "Generating ephemeral key for PR build (not used for publishing)"
          melange keygen

      - name: Upload signing key
        uses: actions/upload-artifact@v4
        with:
          name: melange-ephemeral-key
          path: |
            melange.rsa
            melange.rsa.pub
          retention-days: 1

  #----------------------------------------------------------------------------
  # BUILD MELANGE PACKAGES (native runners per architecture)
  #----------------------------------------------------------------------------
  melange-build:
    needs: [keygen]
    # Always run, but keygen may be skipped (non-PR events)
    if: always()
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Jenkins builds
          - name: jenkins
            melange_config: jenkins/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: jenkins
            melange_config: jenkins/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # Redis builds
          - name: redis-slim
            melange_config: redis-slim/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: redis-slim
            melange_config: redis-slim/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # MySQL builds
          - name: mysql
            melange_config: mysql/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: mysql
            melange_config: mysql/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # MySQL LTS builds
          - name: mysql-lts
            melange_config: mysql-lts/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: mysql-lts
            melange_config: mysql-lts/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # Memcached builds
          - name: memcached
            melange_config: memcached/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: memcached
            melange_config: memcached/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # Caddy builds
          - name: caddy
            melange_config: caddy/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: caddy
            melange_config: caddy/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # HAProxy builds
          - name: haproxy
            melange_config: haproxy/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: haproxy
            melange_config: haproxy/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # PHP builds
          - name: php
            melange_config: php/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: php
            melange_config: php/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm
          # Rails builds
          - name: rails
            melange_config: rails/melange.yaml
            arch: x86_64
            runner: ubuntu-latest
          - name: rails
            melange_config: rails/melange.yaml
            arch: aarch64
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install melange
        run: |
          go install chainguard.dev/melange@v0.41.1
          echo "$HOME/go/bin" >> $GITHUB_PATH

      # For PRs: download ephemeral key from keygen job
      - name: Download ephemeral signing key (PR)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: melange-ephemeral-key
          path: .

      # For push/schedule: use repository secret
      - name: Setup signing key (protected branch)
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.MELANGE_SIGNING_KEY }}" > melange.rsa
          echo "${{ secrets.MELANGE_SIGNING_KEY_PUB }}" > melange.rsa.pub
          chmod 600 melange.rsa

      - name: Build package with melange
        run: |
          chmod 600 melange.rsa
          melange build ${{ matrix.melange_config }} \
            --arch ${{ matrix.arch }} \
            --signing-key melange.rsa \
            --out-dir ./packages \
            --runner docker

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.name }}-${{ matrix.arch }}
          path: |
            packages/
            melange.rsa.pub
          retention-days: 1

  #----------------------------------------------------------------------------
  # BUILD APKO-ONLY IMAGES (no melange dependency)
  #----------------------------------------------------------------------------
  build-apko:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: python
            apko_config: python/apko/python.yaml
            primary_grep: "python-[0-9]"
          - name: node-slim
            apko_config: node-slim/apko/node.yaml
            primary_grep: "nodejs-[0-9]"
          - name: go
            apko_config: go/apko/go.yaml
            primary_grep: "go-[0-9]"
          - name: nginx
            apko_config: nginx/apko/nginx.yaml
            primary_grep: "nginx-mainline"
          - name: httpd
            apko_config: httpd/apko/httpd.yaml
            primary_grep: "apache2"
          - name: postgres-slim
            apko_config: postgres-slim/apko/postgres.yaml
            primary_grep: "postgresql-[0-9]"
          - name: bun
            apko_config: bun/apko/bun.yaml
            primary_grep: "bun"
          - name: sqlite
            apko_config: sqlite/apko/sqlite.yaml
            primary_grep: "sqlite"
          - name: dotnet
            apko_config: dotnet/apko/dotnet.yaml
            primary_grep: "dotnet-[0-9].*-runtime"
          - name: java
            apko_config: java/apko/java.yaml
            primary_grep: "openjdk-[0-9].*-jre"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apko
        run: |
          go install chainguard.dev/apko@v1.1.6
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.4.1'

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image with apko
        run: |
          apko build ${{ matrix.apko_config }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }} \
            ${{ matrix.name }}.tar \
            --arch x86_64
          docker load < ${{ matrix.name }}.tar
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep "minimal-${{ matrix.name }}" | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## ${{ matrix.name }} Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep "minimal-${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY || true

      - name: Install Trivy
        run: |
          curl -sfL --retry 3 --retry-delay 5 https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.69.1
          trivy --version

      - name: Scan image for vulnerabilities
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          trivy image \
            --format json \
            --output trivy-${{ matrix.name }}.json \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            "$IMAGE"

      - name: Generate vulnerability report
        if: always()
        run: |
          REPORT="trivy-${{ matrix.name }}.json"
          if [ ! -f "$REPORT" ]; then
            echo "## Security Scan: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
            echo "Scan report not found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Count vulnerabilities by severity across all results
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$REPORT")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$REPORT")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$REPORT")
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$REPORT")
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

          # Header
          echo "## Security Scan: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan date:** $(date -u +%Y-%m-%d) | **Image:** minimal-${{ matrix.name }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary table
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "| LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL" -eq 0 ]; then
            echo "No vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Detailed table for CRITICAL and HIGH
          if [ "$((CRITICAL + HIGH))" -gt 0 ]; then
            echo "### CRITICAL / HIGH Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Library | CVE | Severity | Installed | Fixed | Title |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----|----------|-----------|-------|-------|" >> $GITHUB_STEP_SUMMARY
            jq -r '
              [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")]
              | sort_by(.Severity) | reverse[]
              | "| \(.PkgName) | \(.VulnerabilityID) | \(.Severity) | \(.InstalledVersion) | \(.FixedVersion // "n/a") | \(.Title // "n/a" | .[0:80]) |"
            ' "$REPORT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "No CRITICAL or HIGH vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload vulnerability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ matrix.name }}
          path: trivy-${{ matrix.name }}.json
          retention-days: 90

      - name: Generate SARIF report
        if: always()
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          trivy image \
            --format sarif \
            --output trivy-${{ matrix.name }}.sarif \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            "$IMAGE" || true

      - name: Upload SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.name }}.sarif'
          category: 'trivy-${{ matrix.name }}'

      - name: Extract version from SBOM
        id: version
        run: |
          # Read primary package name from apko config (source of truth)
          PRIMARY_PKG=$(grep -oE '${{ matrix.primary_grep }}[a-z0-9.\-]*' ${{ matrix.apko_config }} | head -1)
          if [ -z "$PRIMARY_PKG" ]; then
            echo "::error::Failed to extract primary package from ${{ matrix.apko_config }} using pattern '${{ matrix.primary_grep }}'"
            exit 1
          fi
          VERSION=$(jq -r --arg pkg "$PRIMARY_PKG" '.packages[] | select(.name == $pkg) | .versionInfo' sbom-x86_64.spdx.json | head -1)
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "::error::Failed to extract version for $PRIMARY_PKG from SBOM"
            exit 1
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "Primary package: $PRIMARY_PKG, version: $VERSION"
          rm -f sbom-*.spdx.json

      - name: Test image
        run: |
          export IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          ./${{ matrix.name }}/test.sh

      - name: Publish image
        if: github.event_name != 'pull_request'
        run: |
          apko publish ${{ matrix.apko_config }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ steps.version.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:latest \
            --arch x86_64,aarch64

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ steps.version.outputs.tag }}

  #----------------------------------------------------------------------------
  # BUILD MELANGE-BASED IMAGES (needs packages from melange-build)
  #----------------------------------------------------------------------------
  build-melange:
    needs: [melange-build]
    # Always run (keygen ancestor may be skipped), but only if melange-build succeeded
    if: always() && needs.melange-build.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: jenkins
            apko_config: jenkins/apko/jenkins.yaml
            melange_config: jenkins/melange.yaml
          - name: redis-slim
            apko_config: redis-slim/apko/redis.yaml
            melange_config: redis-slim/melange.yaml
          - name: mysql
            apko_config: mysql/apko/mysql.yaml
            melange_config: mysql/melange.yaml
          - name: mysql-lts
            apko_config: mysql-lts/apko/mysql.yaml
            melange_config: mysql-lts/melange.yaml
          - name: memcached
            apko_config: memcached/apko/memcached.yaml
            melange_config: memcached/melange.yaml
          - name: caddy
            apko_config: caddy/apko/caddy.yaml
            melange_config: caddy/melange.yaml
          - name: haproxy
            apko_config: haproxy/apko/haproxy.yaml
            melange_config: haproxy/melange.yaml
          - name: php
            apko_config: php/apko/php.yaml
            melange_config: php/melange.yaml
          - name: rails
            apko_config: rails/apko/rails.yaml
            melange_config: rails/melange.yaml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apko
        run: |
          go install chainguard.dev/apko@v1.1.6
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.4.1'

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download x86_64 packages
        uses: actions/download-artifact@v4
        with:
          name: packages-${{ matrix.name }}-x86_64
          path: ./packages-x86_64

      - name: Download aarch64 packages
        uses: actions/download-artifact@v4
        with:
          name: packages-${{ matrix.name }}-aarch64
          path: ./packages-aarch64

      - name: Merge packages
        run: |
          mkdir -p ./packages
          # Copy x86_64 packages
          cp -r ./packages-x86_64/packages/* ./packages/ 2>/dev/null || true
          # Copy aarch64 packages (merge into same structure)
          cp -r ./packages-aarch64/packages/* ./packages/ 2>/dev/null || true
          # Use signing key from either (they're the same content, different builds)
          cp ./packages-x86_64/melange.rsa.pub ./melange.rsa.pub

          echo "Merged package structure:"
          find ./packages -type f -name "*.apk" | head -20

      # For push/schedule: overwrite with repository public key (for publishing)
      - name: Setup signing key (protected branch)
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.MELANGE_SIGNING_KEY_PUB }}" > melange.rsa.pub

      - name: Build image with apko
        run: |
          apko build ${{ matrix.apko_config }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }} \
            ${{ matrix.name }}.tar \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ./melange.rsa.pub
          docker load < ${{ matrix.name }}.tar
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep "minimal-${{ matrix.name }}" | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## ${{ matrix.name }} Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep "minimal-${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY || true

      - name: Install Trivy
        run: |
          curl -sfL --retry 3 --retry-delay 5 https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.69.1
          trivy --version

      - name: Scan image for vulnerabilities
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          trivy image \
            --format json \
            --output trivy-${{ matrix.name }}.json \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            "$IMAGE"

      - name: Generate vulnerability report
        if: always()
        run: |
          REPORT="trivy-${{ matrix.name }}.json"
          if [ ! -f "$REPORT" ]; then
            echo "## Security Scan: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
            echo "Scan report not found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Count vulnerabilities by severity across all results
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$REPORT")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$REPORT")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$REPORT")
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$REPORT")
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

          # Header
          echo "## Security Scan: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan date:** $(date -u +%Y-%m-%d) | **Image:** minimal-${{ matrix.name }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary table
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "| LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL" -eq 0 ]; then
            echo "No vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Detailed table for CRITICAL and HIGH
          if [ "$((CRITICAL + HIGH))" -gt 0 ]; then
            echo "### CRITICAL / HIGH Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Library | CVE | Severity | Installed | Fixed | Title |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----|----------|-----------|-------|-------|" >> $GITHUB_STEP_SUMMARY
            jq -r '
              [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")]
              | sort_by(.Severity) | reverse[]
              | "| \(.PkgName) | \(.VulnerabilityID) | \(.Severity) | \(.InstalledVersion) | \(.FixedVersion // "n/a") | \(.Title // "n/a" | .[0:80]) |"
            ' "$REPORT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "No CRITICAL or HIGH vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload vulnerability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ matrix.name }}
          path: trivy-${{ matrix.name }}.json
          retention-days: 90

      - name: Generate SARIF report
        if: always()
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          trivy image \
            --format sarif \
            --output trivy-${{ matrix.name }}.sarif \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            "$IMAGE" || true

      - name: Upload SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.name }}.sarif'
          category: 'trivy-${{ matrix.name }}'

      - name: Extract version from melange config
        id: version
        run: |
          PKG_VERSION=$(awk '/^  version:/ {print $2}' "${{ matrix.melange_config }}")
          PKG_EPOCH=$(awk '/^  epoch:/ {print $2}' "${{ matrix.melange_config }}")
          if [ -z "$PKG_VERSION" ]; then
            echo "::error::Failed to extract version from ${{ matrix.melange_config }}"
            exit 1
          fi
          echo "tag=${PKG_VERSION}-r${PKG_EPOCH}" >> $GITHUB_OUTPUT
          echo "Image version: ${PKG_VERSION}-r${PKG_EPOCH}"

      - name: Test image
        run: |
          export IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ github.sha }}"
          ./${{ matrix.name }}/test.sh

      - name: Publish image
        if: github.event_name != 'pull_request'
        run: |
          apko publish ${{ matrix.apko_config }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ steps.version.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:latest \
            --arch x86_64,aarch64 \
            --repository-append ./packages \
            --keyring-append ./melange.rsa.pub

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-${{ matrix.name }}:${{ steps.version.outputs.tag }}

  #----------------------------------------------------------------------------
  # SUMMARY
  #----------------------------------------------------------------------------
  summary:
    needs: [build-apko, build-melange]
    runs-on: ubuntu-latest
    if: always()
    permissions: {}
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.build-apko.result }}" == "failure" ] || [ "${{ needs.build-melange.result }}" == "failure" ]; then
            echo "::error::One or more images failed"
            exit 1
          fi
          echo "All hardened images built successfully!"

  #----------------------------------------------------------------------------
  # CLEANUP OLD VERSIONS
  #----------------------------------------------------------------------------
  cleanup:
    needs: [build-apko, build-melange]
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      packages: write
    steps:
      - name: Delete old untagged versions
        run: |
          gh api "/users/${{ github.repository_owner }}/packages?package_type=container" \
            --paginate --jq '.[].name' 2>/dev/null | \
          while read -r pkg; do
            echo "Cleaning old versions from $pkg..."
            gh api "/users/${{ github.repository_owner }}/packages/container/$pkg/versions" \
              --paginate --jq '[.[] | select(.metadata.container.tags | length == 0)] | sort_by(.created_at) | reverse | .[10:] | .[].id' 2>/dev/null | \
            while read -r id; do
              echo "  Deleting version $id"
              gh api --method DELETE "/users/${{ github.repository_owner }}/packages/container/$pkg/versions/$id" 2>/dev/null || true
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
