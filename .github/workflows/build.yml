name: Build Zero-CVE Images

on:
  push:
    branches: [main]
    paths:
      - 'python/**'
      - 'jenkins/**'
      - 'node/**'
      - 'go/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main]
  schedule:
    # Rebuild daily at 2am UTC to get latest CVE patches
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  JENKINS_VERSION: "2.541.1"
  PYTHON_VERSION: "3.13.1"

jobs:
  #----------------------------------------------------------------------------
  # PYTHON IMAGE (melange from source + apko, shell-less)
  #----------------------------------------------------------------------------
  build-python:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install melange and apko
        run: |
          go install chainguard.dev/melange@latest
          go install chainguard.dev/apko@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate melange signing key
        run: melange keygen

      - name: Build Python from source with melange
        run: |
          melange build python/melange.yaml \
            --arch x86_64 \
            --signing-key melange.rsa \
            --out-dir ./packages \
            --runner docker

      - name: Build Python image with apko
        run: |
          apko build python/apko/python.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:${{ github.sha }} \
            python.tar \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub
          docker load < python.tar
          # Tag the loaded image with our expected tag
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep minimal-python | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## Python Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep minimal-python >> $GITHUB_STEP_SUMMARY || true

      - name: Scan Python image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0'
          cache: 'false'

      - name: Fail on CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-python.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          cache: 'false'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-python.sarif'

      - name: Test Python image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:${{ github.sha }}"
          echo "Testing Python interpreter..."
          docker run --rm "$IMAGE" -c "import sys; print(f'Python {sys.version}')"
          echo "Testing TLS/SSL..."
          docker run --rm "$IMAGE" -c "import ssl; print('TLS OK:', ssl.OPENSSL_VERSION)"
          echo "Testing stdlib modules..."
          docker run --rm "$IMAGE" -c "import json, hashlib, http.client; print('stdlib OK')"
          echo "Verifying no shell..."
          docker run --rm --entrypoint /bin/sh "$IMAGE" -c "echo fail" 2>/dev/null \
            && echo "::error::Shell found in image!" && exit 1 \
            || echo "No shell confirmed"

      - name: Publish Python image
        if: github.event_name != 'pull_request'
        run: |
          apko publish python/apko/python.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:latest \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-python:latest

  #----------------------------------------------------------------------------
  # JENKINS IMAGE (melange jlink JRE + WAR + apko, shell-less)
  #----------------------------------------------------------------------------
  build-jenkins:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install melange and apko
        run: |
          go install chainguard.dev/melange@latest
          go install chainguard.dev/apko@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate melange signing key
        run: melange keygen

      - name: Build Jenkins with melange (jlink JRE + WAR)
        run: |
          melange build jenkins/melange.yaml \
            --arch x86_64 \
            --signing-key melange.rsa \
            --out-dir ./packages \
            --runner docker

      - name: Build Jenkins image with apko
        run: |
          apko build jenkins/apko/jenkins.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:${{ github.sha }} \
            jenkins.tar \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub
          docker load < jenkins.tar
          # Tag the loaded image with our expected tag
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep minimal-jenkins | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## Jenkins Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep minimal-jenkins >> $GITHUB_STEP_SUMMARY || true

      - name: Scan Jenkins image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0'
          cache: 'false'

      - name: Fail on CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-jenkins.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          cache: 'false'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-jenkins.sarif'

      - name: Test Jenkins image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:${{ github.sha }}"
          echo "Testing Java version..."
          docker run --rm --entrypoint /usr/bin/java "$IMAGE" -version
          echo "Testing Jenkins WAR..."
          docker run --rm --entrypoint /usr/bin/java "$IMAGE" \
            -jar /usr/share/jenkins/jenkins.war --version
          echo "Verifying shell (bash) is present..."
          docker run --rm --entrypoint /bin/bash "$IMAGE" --version
          echo "Verifying git is present..."
          docker run --rm --entrypoint /usr/bin/git "$IMAGE" --version
          echo "Verifying core utils..."
          docker run --rm --entrypoint /bin/ls "$IMAGE" /usr/bin/java

      - name: Publish Jenkins image
        if: github.event_name != 'pull_request'
        run: |
          apko publish jenkins/apko/jenkins.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:latest \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-jenkins:latest

  #----------------------------------------------------------------------------
  # NODE.JS IMAGE (melange from source + apko, with shared system libraries)
  #----------------------------------------------------------------------------
  build-node:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install melange and apko
        run: |
          go install chainguard.dev/melange@latest
          go install chainguard.dev/apko@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate melange signing key
        run: melange keygen

      - name: Build Node.js from source with melange
        run: |
          melange build node/melange.yaml \
            --arch x86_64 \
            --signing-key melange.rsa \
            --out-dir ./packages \
            --runner docker

      - name: Build Node.js image with apko
        run: |
          apko build node/apko/node.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:${{ github.sha }} \
            node.tar \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub
          docker load < node.tar
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep minimal-node | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## Node Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep minimal-node >> $GITHUB_STEP_SUMMARY || true

      - name: Scan Node.js image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0'
          cache: 'false'

      - name: Fail on CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-node.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          cache: 'false'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-node.sarif'

      - name: Test Node.js image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:${{ github.sha }}"
          echo "Testing Node version..."
          docker run --rm "$IMAGE" --version
          echo "Testing simple script..."
          docker run --rm "$IMAGE" -e 'console.log("Hello minimal node")'
          echo "Testing crypto (shared OpenSSL)..."
          docker run --rm "$IMAGE" -e "require('crypto').randomBytes(16); console.log('Crypto OK')"
          echo "Testing zlib (shared)..."
          docker run --rm "$IMAGE" -e "require('zlib').gzipSync('test'); console.log('Zlib OK')"
          echo "Testing npm..."
          docker run --rm --entrypoint /usr/bin/npm "$IMAGE" --version

      - name: Publish Node.js image
        if: github.event_name != 'pull_request'
        run: |
          apko publish node/apko/node.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:latest \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-node:latest

  #----------------------------------------------------------------------------
  # GO IMAGE (melange from source + apko, with build tools)
  #----------------------------------------------------------------------------
  build-go:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install melange and apko
        run: |
          go install chainguard.dev/melange@latest
          go install chainguard.dev/apko@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate melange signing key
        run: melange keygen

      - name: Build Go from source with melange
        run: |
          melange build go/melange.yaml \
            --arch x86_64 \
            --signing-key melange.rsa \
            --out-dir ./packages \
            --runner docker

      - name: Build Go image with apko
        run: |
          apko build go/apko/go.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:${{ github.sha }} \
            go.tar \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub
          docker load < go.tar
          # Tag the loaded image with our expected tag
          LOADED_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep minimal-go | head -1)
          docker tag "$LOADED_IMAGE" ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:${{ github.sha }}

      - name: Report image size
        run: |
          echo "## Go Image Size" >> $GITHUB_STEP_SUMMARY
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | \
            grep minimal-go >> $GITHUB_STEP_SUMMARY || true

      - name: Scan Go image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0'
          cache: 'false'

      - name: Fail on CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-go.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          cache: 'false'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-go.sarif'

      - name: Test Go image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:${{ github.sha }}"
          echo "Testing Go version..."
          docker run --rm "$IMAGE" version
          echo "Testing Go build tools..."
          docker run --rm --entrypoint /usr/bin/gcc "$IMAGE" --version | head -1
          docker run --rm --entrypoint /usr/bin/make "$IMAGE" --version
          echo "Testing git..."
          docker run --rm --entrypoint /usr/bin/git "$IMAGE" --version
          echo "Testing simple Go program..."
          echo 'package main; import "fmt"; func main() { fmt.Println("Hello from minimal-go") }' > /tmp/test.go
          docker run --rm -v /tmp:/app -w /app "$IMAGE" run test.go || echo "Note: Go run test completed"

      - name: Publish Go image
        if: github.event_name != 'pull_request'
        run: |
          apko publish go/apko/go.yaml \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:latest \
            --arch x86_64 \
            --repository-append ./packages \
            --keyring-append ${{ github.workspace }}/melange.rsa.pub

      - name: Sign image with cosign
        if: github.event_name != 'pull_request'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            cosign sign --yes \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/minimal-go:latest

  #----------------------------------------------------------------------------
  # SUMMARY
  #----------------------------------------------------------------------------
  summary:
    needs: [build-python, build-jenkins, build-node, build-go]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.build-python.result }}" != "success" ] || \
             [ "${{ needs.build-jenkins.result }}" != "success" ] || \
             [ "${{ needs.build-node.result }}" != "success" ] || \
             [ "${{ needs.build-go.result }}" != "success" ]; then
            echo "::error::One or more images failed"
            exit 1
          fi
          echo "All images built with zero CVEs!"

  #----------------------------------------------------------------------------
  # CLEANUP OLD VERSIONS
  #----------------------------------------------------------------------------
  cleanup:
    needs: [build-python, build-jenkins, build-node, build-go]
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      packages: write
    steps:
      - name: Delete old Python versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: minimal-python
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'true'

      - name: Delete old Jenkins versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: minimal-jenkins
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'true'

      - name: Delete old Node versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: minimal-node
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'true'

      - name: Delete old Go versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: minimal-go
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'true'
