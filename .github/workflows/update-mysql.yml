name: Update MySQL Version

on:
  schedule:
    # Check daily at 6:45am UTC
    - cron: '45 6 * * *'
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new MySQL Innovation version
        id: check
        run: |
          # Get latest MySQL 9.x tag from GitHub (tags use mysql-cluster- prefix)
          LATEST=$(curl -sS --retry 3 --retry-delay 5 \
            "https://api.github.com/repos/mysql/mysql-server/tags?per_page=100" | \
            jq -r '[.[] | select(.name | startswith("mysql-cluster-9.")) | .name] | first' | \
            sed 's/^mysql-cluster-//')

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "::error::Failed to fetch latest MySQL version"
            exit 1
          fi

          # Validate version format strictly
          if ! [[ "$LATEST" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid MySQL version received: $LATEST"
            exit 1
          fi

          # Get current version from melange.yaml
          CURRENT=$(grep '^  version:' mysql/melange.yaml | awk '{print $2}')

          echo "Current version: $CURRENT"
          echo "Latest version: $LATEST"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT -> $LATEST"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Already up to date"
          fi

      - name: Update version and checksum in all files
        if: steps.check.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.check.outputs.new_version }}"
          echo "Updating to MySQL $VERSION"

          # Compute MAJOR_MINOR from version (e.g., 9.6 from 9.6.0)
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)
          echo "Major.minor: $MAJOR_MINOR"

          # Download tarball and compute SHA256 checksum
          echo "Downloading MySQL $VERSION tarball..."
          curl -fsSL --retry 3 --retry-delay 5 "https://dev.mysql.com/get/Downloads/MySQL-${MAJOR_MINOR}/mysql-${VERSION}.tar.gz" \
            -o /tmp/mysql.tar.gz
          SHA256=$(sha256sum /tmp/mysql.tar.gz | awk '{print $1}')
          rm /tmp/mysql.tar.gz
          echo "SHA256: $SHA256"

          # Update mysql/melange.yaml - version
          sed -i "s/^  version: .*/  version: $VERSION/" mysql/melange.yaml

          # Update mysql/melange.yaml - checksum
          sed -i "s/^  sha256: .*/  sha256: $SHA256/" mysql/melange.yaml

          # Update mysql/melange.yaml - major-minor variable
          sed -i "s/^  major-minor: .*/  major-minor: \"$MAJOR_MINOR\"/" mysql/melange.yaml

          # Reset epoch to 0 for new upstream version
          sed -i "s/^  epoch: .*/  epoch: 0/" mysql/melange.yaml

          # Update Makefile
          sed -i "s/MYSQL_VERSION ?= .*/MYSQL_VERSION ?= $VERSION/" Makefile

          # Verify changes
          echo "=== mysql/melange.yaml ==="
          grep -E '(version:|sha256:|major-minor:)' mysql/melange.yaml | head -3
          echo "=== Makefile ==="
          grep 'MYSQL_VERSION' Makefile

      - name: Create Pull Request
        if: steps.check.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore(mysql): bump to ${{ steps.check.outputs.new_version }}"
          body: |
            ## Summary

            Updates MySQL (Innovation) from `${{ steps.check.outputs.current_version }}` to `${{ steps.check.outputs.new_version }}`.

            ## Changes

            - `mysql/melange.yaml` - package version, SHA256 checksum, major-minor variable, epoch reset
            - `Makefile` - MYSQL_VERSION variable

            ## Image Tag

            Once merged, this will publish: `ghcr.io/rtvkiz/minimal-mysql:${{ steps.check.outputs.new_version }}-r0`

            ## Links

            - [MySQL Release Notes](https://dev.mysql.com/doc/relnotes/mysql/innovation/en/)
            - [MySQL Downloads](https://dev.mysql.com/downloads/mysql/)

            ---

            This PR was automatically created by the [update-mysql](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-mysql.yml) workflow.
          branch: update-mysql-${{ steps.check.outputs.new_version }}
          commit-message: |
            chore(mysql): bump to ${{ steps.check.outputs.new_version }}

            Updates MySQL (Innovation) from ${{ steps.check.outputs.current_version }} to ${{ steps.check.outputs.new_version }}.
          delete-branch: true
          labels: |
            dependencies
            mysql
