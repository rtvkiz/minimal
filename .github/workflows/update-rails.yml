name: Update Rails Version

on:
  schedule:
    # Check daily at 7:30am UTC
    - cron: '30 7 * * *'
  workflow_dispatch:

jobs:
  check-rails-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new Rails gem version
        id: check-rails
        run: |
          set -euo pipefail

          # Get current Rails version from melange.yaml
          CURRENT=$(grep 'rails_version:' rails/melange.yaml | awk '{print $2}')

          if [ -z "$CURRENT" ]; then
            echo "::error::Failed to read current Rails version from melange.yaml"
            exit 1
          fi

          SERIES=$(echo "$CURRENT" | cut -d. -f1,2)
          echo "Current Rails version: $CURRENT (series: $SERIES)"

          # Query RubyGems API for latest Rails version
          LATEST=$(curl -fsSL "https://rubygems.org/api/v1/versions/rails/latest.json" | jq -r '.version')

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "::error::Failed to fetch latest Rails version from RubyGems"
            exit 1
          fi

          # Validate version format
          if ! [[ "$LATEST" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid Rails version received: $LATEST"
            exit 1
          fi

          LATEST_SERIES=$(echo "$LATEST" | cut -d. -f1,2)
          echo "Latest Rails version: $LATEST (series: $LATEST_SERIES)"

          if [ "$LATEST_SERIES" != "$SERIES" ]; then
            # Major or minor version change — needs manual review
            echo "new_series=$LATEST_SERIES" >> "$GITHUB_OUTPUT"
            echo "current_series=$SERIES" >> "$GITHUB_OUTPUT"
            echo "New Rails series available: $SERIES -> $LATEST_SERIES"
          elif [ "$LATEST" != "$CURRENT" ]; then
            # Patch update within same series — auto-PR
            {
              echo "update_available=true"
              echo "new_version=$LATEST"
              echo "current_version=$CURRENT"
            } >> "$GITHUB_OUTPUT"
            echo "Rails patch update available: $CURRENT -> $LATEST"
          else
            echo "update_available=false" >> "$GITHUB_OUTPUT"
            echo "Rails is up to date"
          fi

      - name: Update Rails version
        if: steps.check-rails.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.check-rails.outputs.new_version }}"
          echo "Updating Rails to $VERSION"

          # Update rails_version in melange.yaml
          sed -i "s/^  rails_version: .*/  rails_version: $VERSION/" rails/melange.yaml

          # Verify changes
          echo "=== rails/melange.yaml ==="
          grep 'rails_version:' rails/melange.yaml

      - name: Create Rails patch update PR
        if: steps.check-rails.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore(rails): bump Rails gem to ${{ steps.check-rails.outputs.new_version }}"
          body: |
            ## Summary

            Updates Rails gem from `${{ steps.check-rails.outputs.current_version }}` to `${{ steps.check-rails.outputs.new_version }}`.

            ## Changes

            - `rails/melange.yaml` - rails_version variable

            ## Note

            The image tag is derived from the Ruby version, not the Rails gem version.
            The current Ruby version determines the published tag.

            ## Links

            - [Rails Releases](https://rubyonrails.org/category/releases)
            - [RubyGems](https://rubygems.org/gems/rails)

            ---

            This PR was automatically created by the [update-rails](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-rails.yml) workflow.
          branch: update-rails-gem-${{ steps.check-rails.outputs.new_version }}
          commit-message: |
            chore(rails): bump Rails gem to ${{ steps.check-rails.outputs.new_version }}

            Updates Rails from ${{ steps.check-rails.outputs.current_version }} to ${{ steps.check-rails.outputs.new_version }}.
          delete-branch: true
          labels: |
            dependencies
            rails

      - name: Create new Rails series issue
        if: steps.check-rails.outputs.new_series != ''
        uses: actions/github-script@v7
        with:
          script: |
            const newSeries = '${{ steps.check-rails.outputs.new_series }}';
            const currentSeries = '${{ steps.check-rails.outputs.current_series }}';
            const title = `chore(rails): new series available — Rails ${newSeries}`;

            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'rails,dependencies',
            });

            const exists = issues.some(i => i.title.includes(`Rails ${newSeries}`));
            if (exists) {
              console.log(`Issue for Rails ${newSeries} already exists, skipping`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: [
                `## New Rails Series Available`,
                ``,
                `Rails **${newSeries}** is now available. We are currently on **${currentSeries}**.`,
                ``,
                `### Upgrade Checklist`,
                ``,
                `- [ ] Review [Rails upgrade guide](https://guides.rubyonrails.org/upgrading_ruby_on_rails.html)`,
                `- [ ] Review [Rails ${newSeries} release notes](https://rubyonrails.org/category/releases)`,
                `- [ ] Check Ruby version compatibility (Rails ${newSeries} may require a newer Ruby)`,
                `- [ ] Update \`rails/melange.yaml\`:`,
                `  - \`rails_version\` to latest ${newSeries}.x`,
                `- [ ] Update \`rails/apko/rails.yaml\` if gem paths changed`,
                `- [ ] Build and test locally (\`make rails\`)`,
                `- [ ] Verify CI passes`,
                ``,
                `### Why Manual?`,
                ``,
                `Major/minor Rails upgrades can introduce breaking API changes, deprecation removals,`,
                `and new Ruby version requirements. Patch updates (${currentSeries}.x) are auto-PR'd;`,
                `series upgrades require review.`,
                ``,
                `---`,
                ``,
                `Automatically created by the [update-rails](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/workflows/update-rails.yml) workflow.`,
              ].join('\n'),
              labels: ['dependencies', 'rails'],
            });
          github-token: ${{ secrets.GITHUB_TOKEN }}

  check-ruby-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new Ruby version
        id: check-ruby
        run: |
          set -euo pipefail

          # Get current Ruby version from melange.yaml
          CURRENT=$(grep 'ruby_version:' rails/melange.yaml | awk '{print $2}')

          if [ -z "$CURRENT" ]; then
            echo "::error::Failed to read current Ruby version from melange.yaml"
            exit 1
          fi

          SERIES=$(echo "$CURRENT" | cut -d. -f1,2)
          CURRENT_MAJOR=$(echo "$SERIES" | cut -d. -f1)
          CURRENT_MINOR=$(echo "$SERIES" | cut -d. -f2)
          echo "Current Ruby version: $CURRENT (series: $SERIES)"

          # --- Patch update check within current series ---
          # Ruby 4.0+ uses dot-separated tags (v4.0.1), older uses underscores (v3_4_8)
          USCORE_PREFIX="v${SERIES//./_}_"
          LATEST=$(curl -fsSL "https://api.github.com/repos/ruby/ruby/tags?per_page=100" | \
            jq -r --arg dot_prefix "v${SERIES}." --arg uscore_prefix "$USCORE_PREFIX" \
            '[.[] | select((.name | startswith($dot_prefix)) or (.name | startswith($uscore_prefix))) | .name | select(test("preview|rc") | not)] | sort | last // empty' | \
            sed 's/^v//; s/_/./g')

          if [ -z "$LATEST" ]; then
            echo "::error::Failed to determine latest Ruby $SERIES.x version"
            exit 1
          fi

          # Validate version format
          if ! [[ "$LATEST" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid Ruby version: $LATEST"
            exit 1
          fi

          echo "Latest Ruby in $SERIES series: $LATEST"

          if [ "$LATEST" != "$CURRENT" ]; then
            # Download tarball and compute SHA256
            echo "Downloading Ruby $LATEST tarball..."
            curl -fsSL "https://cache.ruby-lang.org/pub/ruby/$SERIES/ruby-$LATEST.tar.gz" \
              -o /tmp/ruby.tar.gz
            SHA256=$(sha256sum /tmp/ruby.tar.gz | awk '{print $1}')
            rm /tmp/ruby.tar.gz
            echo "SHA256: $SHA256"

            {
              echo "update_available=true"
              echo "new_version=$LATEST"
              echo "current_version=$CURRENT"
              echo "sha256=$SHA256"
              echo "series=$SERIES"
            } >> "$GITHUB_OUTPUT"
            echo "Ruby patch update available: $CURRENT -> $LATEST"
          else
            echo "update_available=false" >> "$GITHUB_OUTPUT"
            echo "Ruby $SERIES series is up to date"
          fi

          # --- New series check (minor/major) ---
          NEXT_MINOR="$CURRENT_MAJOR.$((CURRENT_MINOR + 1))"
          NEXT_MAJOR="$((CURRENT_MAJOR + 1)).0"

          echo ""
          echo "Checking for new Ruby series..."

          NEW_SERIES=""

          # Check next minor (e.g. 4.1)
          MINOR_USCORE="v${NEXT_MINOR//./_}_"
          MINOR_TAG=$(curl -fsSL "https://api.github.com/repos/ruby/ruby/tags?per_page=100" | \
            jq -r --arg dot_prefix "v${NEXT_MINOR}." --arg uscore_prefix "$MINOR_USCORE" \
            '[.[] | select((.name | startswith($dot_prefix)) or (.name | startswith($uscore_prefix))) | .name] | sort | last // empty')
          if [ -n "$MINOR_TAG" ]; then
            MINOR_VERSION=$(echo "$MINOR_TAG" | sed 's/^v//; s/_/./g')
            echo "New minor series available: Ruby $NEXT_MINOR (latest: $MINOR_VERSION)"
            NEW_SERIES="$NEXT_MINOR"
          fi

          # Check next major (e.g. 5.0)
          MAJOR_USCORE="v${NEXT_MAJOR//./_}_"
          MAJOR_TAG=$(curl -fsSL "https://api.github.com/repos/ruby/ruby/tags?per_page=100" | \
            jq -r --arg dot_prefix "v${NEXT_MAJOR}." --arg uscore_prefix "$MAJOR_USCORE" \
            '[.[] | select((.name | startswith($dot_prefix)) or (.name | startswith($uscore_prefix))) | .name] | sort | last // empty')
          if [ -n "$MAJOR_TAG" ]; then
            MAJOR_VERSION=$(echo "$MAJOR_TAG" | sed 's/^v//; s/_/./g')
            echo "New major series available: Ruby $NEXT_MAJOR (latest: $MAJOR_VERSION)"
            NEW_SERIES="$NEXT_MAJOR"
          fi

          if [ -n "$NEW_SERIES" ]; then
            echo "new_series=$NEW_SERIES" >> "$GITHUB_OUTPUT"
            echo "current_series=$SERIES" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Ruby version and checksum
        if: steps.check-ruby.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.check-ruby.outputs.new_version }}"
          SHA256="${{ steps.check-ruby.outputs.sha256 }}"
          echo "Updating Ruby to $VERSION"

          # Update ruby_version in melange.yaml
          sed -i "s/^  ruby_version: .*/  ruby_version: $VERSION/" rails/melange.yaml

          # Update package version in melange.yaml
          sed -i "s/^  version: .*/  version: $VERSION/" rails/melange.yaml

          # Update sha256 in melange.yaml
          sed -i "s/^  sha256: .*/  sha256: $SHA256/" rails/melange.yaml

          # Reset epoch to 0 for new upstream version
          sed -i "s/^  epoch: .*/  epoch: 0/" rails/melange.yaml

          # Update Makefile
          sed -i "s/RUBY_VERSION ?= .*/RUBY_VERSION ?= $VERSION/" Makefile

          # Verify changes
          echo "=== rails/melange.yaml ==="
          grep -E '(version:|ruby_version:|sha256:|epoch:)' rails/melange.yaml | head -4
          echo "=== Makefile ==="
          grep 'RUBY_VERSION' Makefile

      - name: Create Ruby patch update PR
        if: steps.check-ruby.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore(rails): bump Ruby to ${{ steps.check-ruby.outputs.new_version }}"
          body: |
            ## Summary

            Updates Ruby from `${{ steps.check-ruby.outputs.current_version }}` to `${{ steps.check-ruby.outputs.new_version }}`.

            ## Changes

            - `rails/melange.yaml` - package version, ruby_version, SHA256 checksum, epoch reset
            - `Makefile` - RUBY_VERSION variable

            ## Image Tag

            Once merged, this will publish: `ghcr.io/rtvkiz/minimal-rails:${{ steps.check-ruby.outputs.new_version }}-r0`

            ## Verification

            The CI pipeline will build Ruby from source and run tests automatically.

            - **Source**: https://cache.ruby-lang.org/pub/ruby/${{ steps.check-ruby.outputs.series }}/ruby-${{ steps.check-ruby.outputs.new_version }}.tar.gz
            - **SHA256**: `${{ steps.check-ruby.outputs.sha256 }}`

            ## Links

            - [Ruby Releases](https://www.ruby-lang.org/en/downloads/)
            - [Ruby News](https://www.ruby-lang.org/en/news/)

            ---

            This PR was automatically created by the [update-rails](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-rails.yml) workflow.
          branch: update-rails-ruby-${{ steps.check-ruby.outputs.new_version }}
          commit-message: |
            chore(rails): bump Ruby to ${{ steps.check-ruby.outputs.new_version }}

            Updates Ruby from ${{ steps.check-ruby.outputs.current_version }} to ${{ steps.check-ruby.outputs.new_version }}.
            SHA256: ${{ steps.check-ruby.outputs.sha256 }}
          delete-branch: true
          labels: |
            dependencies
            rails

      - name: Create new Ruby series issue
        if: steps.check-ruby.outputs.new_series != ''
        uses: actions/github-script@v7
        with:
          script: |
            const newSeries = '${{ steps.check-ruby.outputs.new_series }}';
            const currentSeries = '${{ steps.check-ruby.outputs.current_series }}';
            const title = `chore(rails): new series available — Ruby ${newSeries}`;

            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'rails,dependencies',
            });

            const exists = issues.some(i => i.title.includes(`Ruby ${newSeries}`));
            if (exists) {
              console.log(`Issue for Ruby ${newSeries} already exists, skipping`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: [
                `## New Ruby Series Available`,
                ``,
                `Ruby **${newSeries}** is now available. We are currently on **${currentSeries}**.`,
                ``,
                `### Upgrade Checklist`,
                ``,
                `- [ ] Review [Ruby ${newSeries} release notes](https://www.ruby-lang.org/en/news/)`,
                `- [ ] Check Rails compatibility with Ruby ${newSeries}`,
                `- [ ] Update \`rails/melange.yaml\`:`,
                `  - \`ruby_version\` to latest ${newSeries}.x`,
                `  - \`version\` (package version) to match`,
                `  - \`sha256\` (from ruby-lang.org)`,
                `  - \`tag-filter\` from \`"v${currentSeries.replace(/\./g, '_')}_"\` to \`"v${newSeries.replace(/\./g, '_')}_"\``,
                `- [ ] Update \`rails/apko/rails.yaml\`:`,
                `  - Gem paths if Ruby major version changed (e.g. \`gems/4.0.0\` → \`gems/${newSeries.split('.')[0]}.0.0\`)`,
                `- [ ] Update \`Makefile\` — \`RUBY_VERSION\``,
                `- [ ] Build and test locally (\`make rails\`)`,
                `- [ ] Verify CI passes`,
                ``,
                `### Why Manual?`,
                ``,
                `Minor/major Ruby upgrades can change gem paths, remove deprecated APIs, and affect`,
                `C extension compatibility. Patch updates (${currentSeries}.x) are auto-PR'd; series`,
                `upgrades require review.`,
                ``,
                `---`,
                ``,
                `Automatically created by the [update-rails](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/workflows/update-rails.yml) workflow.`,
              ].join('\n'),
              labels: ['dependencies', 'rails'],
            });
          github-token: ${{ secrets.GITHUB_TOKEN }}
