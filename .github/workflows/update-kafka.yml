name: Update Kafka Version

on:
  schedule:
    # Check daily at 7am UTC
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new Kafka 4.x release
        id: check
        run: |
          # Get latest 4.x release tag from GitHub (apache/kafka)
          # Sort semantically (not by creation date) to always pick the highest version
          LATEST=$(curl -sS --retry 3 --retry-delay 5 \
            "https://api.github.com/repos/apache/kafka/tags?per_page=100" | \
            jq -r '[.[] | select(.name | test("^4\\.[0-9]+\\.[0-9]+$")) | .name]
                   | sort_by(split(".") | map(tonumber)) | last')

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "::error::Failed to fetch latest Kafka 4.x version"
            exit 1
          fi

          # Validate version format
          if ! [[ "$LATEST" =~ ^4\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid Kafka version received: $LATEST"
            exit 1
          fi

          # Get current version from melange.yaml
          CURRENT=$(grep '^  version:' kafka/melange.yaml | awk '{print $2}')

          echo "Current version: $CURRENT"
          echo "Latest version:  $LATEST"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT -> $LATEST"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Already up to date"
          fi

          # Check for next major version (e.g., 5.x when tracking 4.x)
          CURRENT_MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          NEXT_MAJOR=$((CURRENT_MAJOR + 1))
          echo "tracked_version=$CURRENT" >> $GITHUB_OUTPUT
          NEXT_TAG=$(curl -sS --retry 3 --retry-delay 5 \
            "https://api.github.com/repos/apache/kafka/tags?per_page=100" | \
            jq -r --arg next "${NEXT_MAJOR}." \
              '[.[] | .name | select(startswith($next)) | select(test("^[0-9]+\\.[0-9]+\\.[0-9]+$"))] | first // empty')
          if [ -n "$NEXT_TAG" ]; then
            echo "next_major_version=$NEXT_MAJOR" >> $GITHUB_OUTPUT
            echo "next_major_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
            echo "::warning::New major version detected: Kafka ${NEXT_MAJOR}.x ($NEXT_TAG)"
          fi

      - name: Update version and checksum in all files
        if: steps.check.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.check.outputs.new_version }}"
          SCALA_VERSION="2.13"
          echo "Updating to Kafka $VERSION"

          # Download the official binary release tarball and compute SHA512
          echo "Downloading Kafka $VERSION tarball..."
          curl -fsSL --retry 3 --retry-delay 5 \
            "https://downloads.apache.org/kafka/${VERSION}/kafka_${SCALA_VERSION}-${VERSION}.tgz" \
            -o /tmp/kafka.tgz
          SHA512=$(sha512sum /tmp/kafka.tgz | awk '{print $1}')
          rm /tmp/kafka.tgz
          echo "SHA512: $SHA512"

          # Update kafka/melange.yaml - version
          sed -i "s/^  version: .*/  version: $VERSION/" kafka/melange.yaml

          # Update kafka/melange.yaml - sha512
          sed -i "s/^  sha512: .*/  sha512: $SHA512/" kafka/melange.yaml

          # Reset epoch to 0 for new upstream version
          sed -i "s/^  epoch: .*/  epoch: 0/" kafka/melange.yaml

          # Update Makefile
          sed -i "s/KAFKA_VERSION ?= .*/KAFKA_VERSION ?= $VERSION/" Makefile

          # Verify changes
          echo "=== kafka/melange.yaml ==="
          grep -E '(version:|sha512:|epoch:)' kafka/melange.yaml | head -3
          echo "=== Makefile ==="
          grep 'KAFKA_VERSION' Makefile

      - name: Create Pull Request
        if: steps.check.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore(kafka): bump to ${{ steps.check.outputs.new_version }}"
          body: |
            ## Summary

            Updates Apache Kafka from `${{ steps.check.outputs.current_version }}` to `${{ steps.check.outputs.new_version }}`.

            ## Changes

            - `kafka/melange.yaml` - package version, SHA512 checksum, epoch reset
            - `Makefile` - KAFKA_VERSION variable

            ## Image Tag

            Once merged, this will publish: `ghcr.io/rtvkiz/minimal-kafka:${{ steps.check.outputs.new_version }}-r0`

            ## Links

            - [Apache Kafka Releases](https://kafka.apache.org/downloads)
            - [Release Notes for ${{ steps.check.outputs.new_version }}](https://archive.apache.org/dist/kafka/${{ steps.check.outputs.new_version }}/RELEASE_NOTES.html)

            ---

            This PR was automatically created by the [update-kafka](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-kafka.yml) workflow.
          branch: update-kafka-${{ steps.check.outputs.new_version }}
          commit-message: |
            chore(kafka): bump to ${{ steps.check.outputs.new_version }}

            Updates Apache Kafka from ${{ steps.check.outputs.current_version }} to ${{ steps.check.outputs.new_version }}.
          delete-branch: true
          labels: |
            dependencies
            kafka

      - name: Create new major version issue
        if: steps.check.outputs.next_major_version != ''
        uses: actions/github-script@v7
        with:
          script: |
            const nextMajor = '${{ steps.check.outputs.next_major_version }}';
            const nextTag = '${{ steps.check.outputs.next_major_tag }}';
            const currentVersion = '${{ steps.check.outputs.tracked_version }}';
            const currentMajor = currentVersion.split('.')[0];
            const title = `chore(kafka): new major version available â€” Kafka ${nextMajor}.x`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'kafka,dependencies',
            });
            if (issues.some(i => i.title.includes(`Kafka ${nextMajor}.x`))) {
              console.log(`Issue for Kafka ${nextMajor}.x already exists, skipping`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              labels: ['dependencies', 'kafka'],
              body: [
                `## New Major Version Detected`,
                ``,
                `Apache Kafka **${nextMajor}.x** has been detected (first tag: \`${nextTag}\`).`,
                `We are currently tracking **${currentMajor}.x** (${currentVersion}).`,
                ``,
                `### Upgrade Checklist`,
                ``,
                `- [ ] Review the [Kafka ${nextMajor}.x release notes](https://kafka.apache.org/downloads) and migration guide`,
                `- [ ] Verify StorageTool class name (changed between major versions)`,
                `- [ ] Check config file paths (e.g., \`config/server.properties\` vs \`config/kraft/server.properties\`)`,
                `- [ ] Verify Log4j config format and JVM flags`,
                `- [ ] Check JAR naming convention (hyphens vs underscores, Scala version suffix)`,
                `- [ ] Verify jlink module requirements haven't changed`,
                `- [ ] Update \`update-kafka.yml\`: change tag filter from \`^${currentMajor}\\\\.\` to \`^${nextMajor}\\\\.\``,
                `- [ ] Update \`kafka/melange.yaml\`: version, sha512, \`tag-filter\``,
                `- [ ] Test image build and run \`kafka/test.sh\``,
                ``,
                `### Links`,
                ``,
                `- [Kafka Downloads](https://kafka.apache.org/downloads)`,
                `- [First ${nextMajor}.x tag: \`${nextTag}\`](https://github.com/apache/kafka/releases/tag/${nextTag})`,
                ``,
                `---`,
                `*Detected by the [update-kafka](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/update-kafka.yml) workflow.*`,
              ].join('\n'),
            });
