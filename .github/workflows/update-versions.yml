name: Update Package Versions

on:
  schedule:
    # Run daily at 1am UTC (before the 2am build)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install wolfictl
        uses: wolfi-dev/actions/install-wolfictl@main

      - name: Update Python
        id: python-update
        run: |
          cd python
          wolfictl update melange.yaml --create-pr=false > update.log 2>&1 || true
          if git diff --quiet melange.yaml; then
            echo "No updates for Python"
            echo "update_available=false" >> $GITHUB_OUTPUT
          else
            echo "Python updated!"
            echo "update_available=true" >> $GITHUB_OUTPUT
            NEW_VER=$(grep '^  version:' melange.yaml | awk '{print $2}')
            echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          fi

      - name: Update Jenkins
        id: jenkins-update
        run: |
          cd jenkins
          wolfictl update melange.yaml --create-pr=false > update.log 2>&1 || true
          if git diff --quiet melange.yaml; then
            echo "No updates for Jenkins"
            echo "update_available=false" >> $GITHUB_OUTPUT
          else
            echo "Jenkins updated!"
            echo "update_available=true" >> $GITHUB_OUTPUT
            NEW_VER=$(grep '^  version:' melange.yaml | awk '{print $2}')
            echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          fi

      # Node.js uses Wolfi's pre-built package (no melange.yaml)
      # Version updates come automatically from Wolfi repository

      - name: Update Go
        id: go-update
        run: |
          cd go
          wolfictl update melange.yaml --create-pr=false > update.log 2>&1 || true
          if git diff --quiet melange.yaml; then
            echo "No updates for Go"
            echo "update_available=false" >> $GITHUB_OUTPUT
          else
            echo "Go updated!"
            echo "update_available=true" >> $GITHUB_OUTPUT
            NEW_VER=$(grep '^  version:' melange.yaml | awk '{print $2}')
            echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          fi

      - name: Update Nginx
        id: nginx-update
        run: |
          cd nginx
          wolfictl update melange.yaml --create-pr=false > update.log 2>&1 || true
          if git diff --quiet melange.yaml; then
            echo "No updates for Nginx"
            echo "update_available=false" >> $GITHUB_OUTPUT
          else
            echo "Nginx updated!"
            echo "update_available=true" >> $GITHUB_OUTPUT
            NEW_VER=$(grep '^  version:' melange.yaml | awk '{print $2}')
            echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          fi

      - name: Update HTTPD
        id: httpd-update
        run: |
          cd httpd
          wolfictl update melange.yaml --create-pr=false > update.log 2>&1 || true
          if git diff --quiet melange.yaml; then
            echo "No updates for HTTPD"
            echo "update_available=false" >> $GITHUB_OUTPUT
          else
            echo "HTTPD updated!"
            echo "update_available=true" >> $GITHUB_OUTPUT
            NEW_VER=$(grep '^  version:' melange.yaml | awk '{print $2}')
            echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.python-update.outputs.update_available == 'true' || steps.jenkins-update.outputs.update_available == 'true' || steps.go-update.outputs.update_available == 'true' || steps.nginx-update.outputs.update_available == 'true' || steps.httpd-update.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update package versions (daily auto-update)

            ${{ steps.python-update.outputs.update_available == 'true' && format('- Python: {0}', steps.python-update.outputs.new_version) || '' }}
            ${{ steps.jenkins-update.outputs.update_available == 'true' && format('- Jenkins: {0}', steps.jenkins-update.outputs.new_version) || '' }}
            ${{ steps.go-update.outputs.update_available == 'true' && format('- Go: {0}', steps.go-update.outputs.new_version) || '' }}
            ${{ steps.nginx-update.outputs.update_available == 'true' && format('- Nginx: {0}', steps.nginx-update.outputs.new_version) || '' }}
            ${{ steps.httpd-update.outputs.update_available == 'true' && format('- HTTPD: {0}', steps.httpd-update.outputs.new_version) || '' }}
          branch: auto-update/package-versions
          delete-branch: true
          title: "chore: update package versions"
          body: |
            ## Automated Version Updates

            This PR was automatically generated by wolfictl.

            ### Updated Packages
            ${{ steps.python-update.outputs.update_available == 'true' && format('- **Python**: `{0}`', steps.python-update.outputs.new_version) || '- Python: Up to date' }}
            ${{ steps.jenkins-update.outputs.update_available == 'true' && format('- **Jenkins**: `{0}`', steps.jenkins-update.outputs.new_version) || '- Jenkins: Up to date' }}
            ${{ steps.go-update.outputs.update_available == 'true' && format('- **Go**: `{0}`', steps.go-update.outputs.new_version) || '- Go: Up to date' }}
            ${{ steps.nginx-update.outputs.update_available == 'true' && format('- **Nginx**: `{0}`', steps.nginx-update.outputs.new_version) || '- Nginx: Up to date' }}
            ${{ steps.httpd-update.outputs.update_available == 'true' && format('- **HTTPD**: `{0}`', steps.httpd-update.outputs.new_version) || '- HTTPD: Up to date' }}
            - Node.js: Uses Wolfi pre-built package (auto-updated via Wolfi repo)

            ### Verification
            - [ ] CI build passes
            - [ ] CVE scan passes
          labels: |
            dependencies
            automated
