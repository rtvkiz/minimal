name: Update Package Versions

on:
  schedule:
    # Run daily at 1am UTC (before the 2am build)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install wolfictl
        run: |
          go install chainguard.dev/wolfictl@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Check for Python updates
        id: python-update
        run: |
          cd python
          echo "Checking for Python updates..."
          
          # Get current version
          CURRENT_VERSION=$(grep '^  version:' melange.yaml | head -1 | awk '{print $2}' | tr -d '"')
          echo "Current Python version: $CURRENT_VERSION"
          
          # Check latest release from GitHub API
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/python/cpython/tags?per_page=100" | \
            jq -r '.[].name' | grep '^v3\.13\.' | head -1 | sed 's/^v//')
          echo "Latest Python 3.13.x version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ -n "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            
            # Update the version in melange.yaml
            sed -i "s/version: $CURRENT_VERSION/version: $LATEST_VERSION/" melange.yaml
            echo "Updated Python to $LATEST_VERSION"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Python is already at latest version: $CURRENT_VERSION"
          fi

      - name: Check for Jenkins updates
        id: jenkins-update
        run: |
          cd jenkins
          echo "Checking for Jenkins updates..."
          
          # Get current version
          CURRENT_VERSION=$(grep '^  version:' melange.yaml | head -1 | awk '{print $2}' | tr -d '"')
          echo "Current Jenkins version: $CURRENT_VERSION"
          
          # Extract major.minor for LTS line (e.g., 2.541 from 2.541.1)
          LTS_LINE=$(echo "$CURRENT_VERSION" | cut -d. -f1,2)
          
          # Check latest LTS release from Jenkins update center
          LATEST_VERSION=$(curl -s "https://updates.jenkins.io/stable/latestCore.txt")
          echo "Latest Jenkins LTS version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ -n "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            
            # Update the version in melange.yaml
            sed -i "s/version: $CURRENT_VERSION/version: $LATEST_VERSION/" melange.yaml
            echo "Updated Jenkins to $LATEST_VERSION"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Jenkins is already at latest version: $CURRENT_VERSION"
          fi

      - name: Check for Node.js updates
        id: node-update
        run: |
          cd node
          echo "Checking for Node.js updates..."
          
          # Get current version
          CURRENT_VERSION=$(grep '^  version:' melange.yaml | head -1 | awk '{print $2}' | tr -d '"')
          echo "Current Node version: $CURRENT_VERSION"
          
          # Check latest release from nodejs.org (tracking v23.x)
          LATEST_VERSION=$(curl -s https://nodejs.org/dist/index.json | jq -r '.[].version' | grep '^v23\.' | head -1 | sed 's/^v//')
          echo "Latest Node v23.x version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ -n "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            
            # Update the version in melange.yaml
            sed -i "s/version: $CURRENT_VERSION/version: $LATEST_VERSION/" melange.yaml
            echo "Updated Node to $LATEST_VERSION"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Node is already at latest version: $CURRENT_VERSION"
          fi

      - name: Create Pull Request
        if: steps.python-update.outputs.update_available == 'true' || steps.jenkins-update.outputs.update_available == 'true' || steps.node-update.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update package versions
            
            ${{ steps.python-update.outputs.update_available == 'true' && format('- Python: {0} → {1}', steps.python-update.outputs.current_version, steps.python-update.outputs.new_version) || '' }}
            ${{ steps.jenkins-update.outputs.update_available == 'true' && format('- Jenkins: {0} → {1}', steps.jenkins-update.outputs.current_version, steps.jenkins-update.outputs.new_version) || '' }}
            ${{ steps.node-update.outputs.update_available == 'true' && format('- Node.js: {0} → {1}', steps.node-update.outputs.current_version, steps.node-update.outputs.new_version) || '' }}
          branch: auto-update/package-versions
          delete-branch: true
          title: "chore: update package versions"
          body: |
            ## Automated Version Updates
            
            This PR was automatically generated by the version update workflow.
            
            ### Changes
            ${{ steps.python-update.outputs.update_available == 'true' && format('- **Python**: `{0}` → `{1}`', steps.python-update.outputs.current_version, steps.python-update.outputs.new_version) || '- **Python**: Already up to date' }}
            ${{ steps.jenkins-update.outputs.update_available == 'true' && format('- **Jenkins**: `{0}` → `{1}`', steps.jenkins-update.outputs.current_version, steps.jenkins-update.outputs.new_version) || '- **Jenkins**: Already up to date' }}
            ${{ steps.node-update.outputs.update_available == 'true' && format('- **Node.js**: `{0}` → `{1}`', steps.node-update.outputs.current_version, steps.node-update.outputs.new_version) || '- **Node.js**: Already up to date' }}
            
            ### Verification
            - [ ] CI build passes
            - [ ] CVE scan passes
            - [ ] Images work correctly
            
            ---
            _Merge this PR to update the images, then the daily build will use the new versions._
          labels: |
            dependencies
            automated
