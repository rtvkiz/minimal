name: Cleanup Untagged Package Versions

on:
  workflow_dispatch:

permissions: {}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete all untagged versions across all packages
        run: |
          OWNER="${{ github.repository_owner }}"

          PACKAGES=$(gh api "/users/${OWNER}/packages?package_type=container" \
            --paginate --jq '.[].name' 2>/dev/null)

          if [ -z "$PACKAGES" ]; then
            echo "No packages found."
            exit 0
          fi

          for pkg in $PACKAGES; do
            echo "── $pkg"
            UNTAGGED_IDS=$(gh api "/users/${OWNER}/packages/container/${pkg}/versions" \
              --paginate \
              --jq '[.[] | select(.metadata.container.tags | length == 0)] | .[].id' \
              2>/dev/null)

            if [ -z "$UNTAGGED_IDS" ]; then
              echo "   no untagged versions"
              continue
            fi

            COUNT=$(echo "$UNTAGGED_IDS" | wc -l)
            echo "   deleting $COUNT untagged version(s)..."

            for id in $UNTAGGED_IDS; do
              if gh api --method DELETE \
                "/users/${OWNER}/packages/container/${pkg}/versions/${id}" \
                2>/dev/null; then
                echo "   deleted $id"
              else
                echo "   skipped $id (may be referenced by a tagged image)"
              fi
            done
          done

          echo "Done."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
