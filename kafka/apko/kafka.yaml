# Minimal Apache Kafka image - official binary release + custom jlink JRE
# KRaft mode only (no ZooKeeper) - Kafka 4.x
# CVE patching via daily rebuilds

contents:
  repositories:
    - https://packages.wolfi.dev/os
    # Local melange-built packages (passed via --repository-append CLI flag)
  keyring:
    - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    # Local signing key passed via --keyring-append CLI flag
  packages:
    # Base filesystem
    - wolfi-baselayout

    # Shell required for KRaft initialisation entrypoint
    - busybox

    # Our Kafka (binary release + custom JRE via melange)
    - kafka-minimal

    # Core libraries for JNI / native JRE components
    - glibc
    - glibc-locale-posix
    - ld-linux

    # Certificates
    - ca-certificates-bundle

accounts:
  groups:
    - groupname: kafka
      gid: 65532
  users:
    - username: kafka
      uid: 65532
      gid: 65532
  run-as: 65532

entrypoint:
  command: /usr/bin/kafka-entrypoint.sh

environment:
  PATH: /usr/bin:/bin
  KAFKA_DATA: /var/kafka/data
  KAFKA_CONFIG: /opt/kafka/config/server.properties
  KAFKA_HEAP_OPTS: -Xmx1G -Xms256M

paths:
  - path: /var/kafka/data
    type: directory
    uid: 65532
    gid: 65532
    permissions: 0o755
  - path: /var/log/kafka
    type: directory
    uid: 65532
    gid: 65532
    permissions: 0o755
  - path: /opt/kafka/config
    type: directory
    uid: 65532
    gid: 65532
    permissions: 0o755
  - path: /tmp
    type: directory
    uid: 65532
    gid: 65532
    permissions: 0o1777

annotations:
  org.opencontainers.image.title: "minimal-kafka"
  org.opencontainers.image.description: "Hardened Apache Kafka image with custom jlink JRE, KRaft mode, daily CVE patches"
  org.opencontainers.image.url: "https://github.com/rtvkiz/minimal"
  org.opencontainers.image.source: "https://github.com/rtvkiz/minimal/tree/main/kafka"
  org.opencontainers.image.licenses: "Apache-2.0"

archs:
  - x86_64
  - aarch64
